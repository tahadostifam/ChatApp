# Databases detail

#### CONFIGS
* `backend/configs/configs.json` :: Ports, DBs configs, etc
* `backend/configs/secrets.json` :: JWT Secrets   

  Generating new secret key :   
  ```ruby
  ruby backend/configs/secret_generator.rb
  ```

### MongoDB
Relevant files : 
* `backend/lib/database.ts`
* `backend/models/*`

##### Collections
  * Users
  * Chats

 
##### Users Collection
Schema   
```javascript
"_id": "620d0ca783820a348eec7f7d", // a unique id for every created user (index, unique)
"full_name": "Taha. Dostifam", // Fullname
"username": "tahad", // Username (unique)
"password_digest": "...", // encrypted Password 
"bio": "Full-Stack Web Developer based on Iran/Bonab", // Biography
"chats": [
  {
    "chat_id": "620d0e4583820a348eec800b" // a reference to chats collection
  }
],
"profile_photos": [
  {
    "filename": "5e3baceb42f7988d8491bbdcc998ec" // filename of profile_picture
  }
],
"last_seen": "1645023937167"
```
Notes :
  * All profile_photos saving in `backend/uploads/profile_photos`.   
  * We encrypt password for more security; it means that only the user knows her password.   


#### Chats Collection
  * Chats
    * Private
      ```javascript
      {
          "_id": "620d0df883820a348eec7fe8",
          "sides": {
              "user_1": "desktop1",
              "user_2": "tahad"
          },
          "chat_type": "private",
          "messages_list": [],
      }
      ```
    * Channel
      ```javascript
      {
          "_id": "620d0e8083820a348eec802d",
          "full_name": "MyChannel",
          "username": "my_channel",
          "bio": "Biography",
          "profile_photos": [{ "filename": "601d689a4d2bc595b1f7f3cd00ed20" }],
          "creator_username": "tahad",
          "members": ["desktop1", "desktop2"],
          "admins": ["desktop1"],
          "chat_type": "channel",
          "messages_list": []
      }
      ```
    * Group
      ```javascript
      {
          "full_name": "MyGroup",
          "username": "my_group",
          "profile_photos": [],
          "creator_username": "tahad",
          "members": ["desktop1"],
          "admins": [],
          "chat_type": "group",
          "messages_list": []
      }
      ```

  * Messages :
    * Text Message : 
      ```javascript
      {
          "message_id": "620d0df883820a348eec7fe5",
          "sender_username": "desktop1",
          "message_type": "text",
          "send_time": 1645022712568,
          "content": "Hello World",
          "edited": false,
          "seen_state": "sended"
      },
      ```
     * Photo Message :
        ```javascript
        {
            "message_id": "620d131783820a348eec815f",
            "sender_username": "tahad",
            "message_type": "photo",
            "send_time": 1645024023454,
            "edited": false,
            "seen_state": "sended",
            "filename": "72d0698ed0ed065c067f",
            "caption": "Photo :]"
        }
      ```
      
### Redis
Relevant file : `backend/lib/store.ts`   

#### Key Rules
```javascript
`${username}_${token_type}_${user_ip}`
// example 
// tahad_auth_127001
```

#### Values
  * refresh_token
    ```txt
    eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InRhaGFkIiwiaWF0IjoxNjQ1MDQzNDM5fQ.24pOpyT573Mcea_GkeanslRqfbhH5NnXgziEXfCQKKs
    ```
  * auth_token
    ```txt
    bf327b91e76c99d7a45e029a1f29871495785c922fe0af175f
    ```
    
#### What are these tokens made of?
  * refresh_token
    refresh_token generated by jsonwebtoken and its paylod is something like :
    ```javascript
    {"username": "username_of_logged_user"}
    ```
  * auth_token
    auth_token generated by crypto; its just a random string, nothing more.
    you may be wondering, how we do finding the user with auth_token? yeah! i know!
    i made a really mistake in this section but i think that jwt tokens are really long
    for this reason i just make a random string using crypto but when users wanna authenticate i have to get his username too.
    maybe the reason is not really enough...
    however, i think this will speed up our authentication.
    
